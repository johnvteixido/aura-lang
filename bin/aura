#!/usr/bin/env ruby

require "aura"

if ARGV.empty?
  puts <<~WELCOME
    ðŸŒŸ Welcome to Aura v0.1 ðŸŒŸ
    A forgiving, human-friendly language for AI and fast web apps.

    Usage:
      aura run examples/mnist_classifier.aura  # Run an Aura file
  WELCOME
  exit
end

command = ARGV[0]
filename = ARGV[1]

case command
when "run"
  if filename && File.exist?(filename)
    Aura.run_file(filename)
  else
    puts "ðŸ˜” File not found: #{filename}."
    puts "Creating a basic template for you! ðŸŒŸ"
    File.write(filename, <<~AURA)
      model greeter neural_network do
        input text
        output greeting "Hello from Aura! ðŸŒŸ"
      end

      route "/hello" get do
        output prediction from greeter.predict(input) format :json
      end

      run web on port: 3000
    AURA
    puts "âœ… Created #{filename}. Run 'aura run #{filename}' to start it."
  end
when "--help", "-h", "help"
  puts <<~HELP
    ðŸŒŸ Aura v0.1 CLI ðŸŒŸ
    Usage:
      aura run <file.aura>  - Parse, transpile, and execute script.
      aura repl             - Start an interactive Aura REPL session.
      aura --help           - Display this help message.
  HELP
when "repl"
  require "readline"
  puts "ðŸŒŸ Welcome to the Aura REPL v0.1! Type '.exit' to quit."
  puts "   (Multilines supported for 'do...end' blocks.)"
  
  buffer = ""
  while (line = Readline.readline(buffer.empty? ? "aura> " : "   *> ", true))
    break if line == ".exit" || line == "exit"
    next if line.strip.empty?
    
    buffer += line + "\n"
    
    begin
      Aura.parse(buffer) # Try to parse
      ruby_code = Aura.transpile(buffer)
      
      puts "=> \e[32mTranspiled & Evaluated Successfully\e[0m"
      begin
        # For REPL safety, evaluate in a clean context but keep state if possible
        eval(ruby_code, TOPLEVEL_BINDING)
      rescue => e
        puts "ðŸ˜” Ruby Evaluation Error: #{e.message}"
      end
      
      buffer = "" # Clear buffer on success
    rescue Parslet::ParseFailed => e
      # If it failed because it's incomplete (like missing "end"), keep buffering
      if buffer.include?("do\n") && !buffer.match?(/\send\n?$/)
        # Still typing a block, continue buffering
      else
        # It's a genuine syntax error, not just an incomplete block
        puts "ðŸ˜” Aura Syntax Error. Clearing buffer."
        buffer = ""
      end
    end
  end
  puts "Goodbye! ðŸŒŸ"
else
  puts "ðŸ˜” Unknown command: #{command}. Try 'aura --help'."
end
